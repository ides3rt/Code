#!/usr/bin/env bash

rmenu() { rofi -dmenu -i -p 'Select'; }

Log="${XDG_DATA_HOME:-$HOME/.local/share}"/0x0.log

[[ -d $XDG_DATA_HOME ]] || mkdir -p -- "$XDG_DATA_HOME"
[[ -f $Log ]] || > "$Log"

Options=(
	'Upload a File'
	'Recent Upload(s)'
)

Selected=$(printf '%s\n' "${Options[@]}" | rmenu)

case "$Selected" in
	"${Options[0]}")
		Target="$PWD"

		while :; do
			Selected=$({ echo ..; ls -ANp1 --group-directories-first -- "$Target"; } | rmenu)
			[[ -z $Selected ]] && exit 0

			if [[ $Selected == /* ]]; then
				NewTarget="$Selected"
			else
				NewTarget=$(realpath -- "${Target%%/}/$Selected")
			fi

			if [[ -f $NewTarget ]]; then
				if ! URL=$(curl -sF file=@"$NewTarget" https://0x0.st); then
					dunstify -u critical -- 'Error:' 'Failed to Upload to https://0x0.st'
					exit 1
				fi

				printf '%s' "$URL" | xclip -sel c
				printf '%s' "$URL" | xclip -sel p

				dunstify -u low -- 'File Uploaded' "URL: $URL"

				echo "$(printf '%(%F_%T)T') $URL ${NewTarget##*/}" >> "$Log"

				exit 0
			fi

			[[ -d $NewTarget ]] && Target="$NewTarget"
		done ;;

	"${Options[1]}")
		read -a URL <<< "$(column -t -- "$Log" | tac | rmenu)"
		[[ -z $URL ]] && exit 0

		printf '%s' "${URL[1]}" | xclip -sel c
		printf '%s' "${URL[1]}" | xclip -sel p

		dunstify -u low -- 'Copied to Clipboard' "URL: ${URL[1]}" ;;
esac
