#!/usr/bin/env bash

# Dependencies):
#   coreutils (bash, ls)
#   curl (Upload utility)
#   dmenu/rofi (Default run menu)
#   xclip (Clipboard support)
#   dunst (dunstify)
#   notify-send (dunstify)

if ! type -P dmenu &>/dev/null; then
	dmenu() { rofi -dmenu "$@"; }
fi

Log="${XDG_DATA_HOME:-$HOME/.local/share}"/0x0.log

[[ -d $XDG_DATA_HOME ]] || mkdir -p -- "$XDG_DATA_HOME"
[[ -f $Log ]] || > "$Log"

Options=(
	'Upload a File'
	'Recent Upload(s)'
)

Selected=$(printf '%s\n' "${Options[@]}" | dmenu -i -p 'Select')

case $Selected in
	${Options[0]})
		ls() {
			echo ..
			command ls -ALNpX1 --group-directories-first "$@"
		}

		while :; do
			Selected=$(ls | dmenu -i -p "$PWD")
			[[ -z $Selected ]] && exit 0

			if [[ -f $Selected ]]; then
				if ! URL=$(curl -sF file=@"$Selected" https://0x0.st); then
					dunstify -u critical -- 'Error:' 'Failed to Upload'
					exit 1
				fi

				printf '%s' "$URL" | xclip -sel c
				printf '%s' "$URL" | xclip -sel p

				dunstify -u low -- 'File Uploaded' "URL: $URL"
				echo "$(printf '%(%F_%T)T') $URL $Selected" >> "$Log"

				exit 0
			elif [[ -d $Selected ]]; then
				if ! cd -- "$Selected"; then
					dunstify -u normal -- 'Error:' 'The Directory not Readable'
				fi
			else
				dunstify -u normal -- 'Error:' 'Wrong File Type'
				exit 1
			fi
		done ;;

	${Options[1]})
		while read -r; do
			Data=("$REPLY" "${Data[@]}")
		done < "$Log"

		read _ URL _ <<< "$(printf '%s\n' "${Data[@]}" | dmenu -i -p 'Select')"
		[[ -z $URL ]] && exit 0

		printf '%s' "$URL" | xclip -sel c
		printf '%s' "$URL" | xclip -sel p

		dunstify -u low -- 'Copied to Clipboard' "URL: $URL" ;;
esac
